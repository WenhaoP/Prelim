---
title: "Untitled"
author: "Wenhao Pan"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, root.dir = rprojroot::find_rstudio_root_file())
```

# Variable name interpretation

Here is the interpretation of the variable names in the Asadi et al.'s (2015) code

* `CatCntrWt`: Hydrological locations $H(t)$.
* `EucDis`: Euclidean distances between gauging stations.
* `RiverDis`: River distances between gauging stations, $d(s,t)$.
* `Weight`: River weights, $\pi_k$'s.
* `StsInfo`: River name, latitude, longtitude, and average volume of each gauging station.
* `StsTSs`: Average daily discharge of each station from 1900 to 2014 with missing data.
* `ComTSs`: Common measurements (daily measurement in June, July, and August during 1960 - 2010) at all stations.
* `CommonMaxima`: Annual maxima of common measurements at all stations.

# Data verification

```{r}
library(ggplot2)
library(tidyr)
library(dplyr)
root.dir <- rprojroot::find_rstudio_root_file()
source(paste(root.dir, "/Codes/Functions.R", sep=""))

# Loading the data provided by the original authors
# FileList <- list.files(path = "C:/Code/Prelim/Data")
FileList <- list.files(path = "D:/Code/Prelim/Data")
for (i in 1:length(FileList)){
  # load(paste("C:/Code/Prelim/Data", FileList[i], sep="/"))
  load(paste("D:/Code/Prelim/Data", FileList[i], sep="/"))
}
StsChos <- c(1:31) # Station indices
NoSt <- length(StsChos) # Total number of stations
```

```{r}
# check the range of daily average discharges at each station
sapply(StsTSs, function(x) mean(x$Val))
```

```{r}
# check CommonMaxima
ComTSs.copy <- data.frame(ComTSs)
colnames(ComTSs.copy)[2:32] <- as.character(1:31)
CommonMaxima.test <- ComTSs.copy %>%
  pivot_longer(
    -Date, 
    names_to = "Station", 
    values_to = "Discharge"
  ) %>%
  mutate(Station = as.integer(Station), Year = format(Date, "%Y")) %>%
  filter(Year <= 2009) %>%
  group_by(Station, Year) %>%
  summarize(AnnualMax = max(Discharge, na.rm = TRUE), .groups = "drop") %>%
  arrange(Station, Year)

# should return true
all(CommonMaxima.test$AnnualMax == as.vector(CommonMaxima))
```

# Plots

## Figure 6

```{r}
# check that most extreme discharges happen in summer

# station 1 in 2005
station.1 <- as.data.frame(StsTSs[1])
station.1$Date <- as.Date(station.1$Date)
ggplot(station.1, aes(x = Date, y = Val)) +
  annotate("rect",
           xmin = as.Date("2005-06-01"),
           xmax = as.Date("2005-08-31"),
           ymin = -Inf, ymax = Inf,
           alpha = 0.2, fill = "skyblue") +
  geom_line() +
  scale_x_date(
    date_breaks = "1 month", date_labels = "%b",
    limits = as.Date(c("2005-01-01", "2005-12-31"))) +
  theme_minimal() +
  theme(text = element_text(size = 16)) +
  labs(
    title = "Average daily dicharge of gauging station 1 in 2005",
    x = "Time", y = "Average daily dicharge")
ggsave(paste(root.dir, "/Plots/station_1_2005.png", sep=""))

# station 19 in 2002
station.19 <- as.data.frame(StsTSs[19])
station.19$Date <- as.Date(station.19$Date)
ggplot(station.19, aes(x = Date, y = Val)) +
  annotate("rect",
           xmin = as.Date("2002-06-01"),
           xmax = as.Date("2002-08-31"),
           ymin = -Inf, ymax = Inf,
           alpha = 0.2, fill = "skyblue") +
  geom_line() +
  scale_x_date(
    date_breaks = "1 month", date_labels = "%b",
    limits = as.Date(c("2002-01-01", "2002-12-31"))) +
  theme_minimal() +
  theme(text = element_text(size = 16)) +
  labs(
    title = "Average daily dicharge of gauging station 19 in 2002",
    x = "Time", y = "Average daily dicharge")
ggsave(paste(root.dir, "/Plots/station_19_2002.png", sep=""))
```

## Figure 7: declustering 

```{r}
# check declustering 
Years <- unique(as.numeric(substr(ComTSs[, 1], 1, 4)))
U <- 0.1
Lag <- 4
Plotting <- 0
StNames <- as.character(StsChos)
YearsWithEvent <- numeric()
AllEvMat <- matrix(0, length(StNames), 1)
AllRes <- list()
for (i in 1:length(Years)){
  cat(paste("Declustering year", Years[i], "\n"))
  Res <- ObtainMultVarEvents(
    TSs = ComTSs, U = U, Lag = Lag, Year = Years[i],
    StNames = StNames, Plotting = Plotting, mfrow = c(NoSt,1))  ## For Censored Likelihood
  Events <- Res$AllEvMat
  Locations <- Res$Location
  if (length(Events) > 0) {
    YearsWithEvent <- c(YearsWithEvent, rep(Years[i], dim(Events)[2]))
    AllEvMat <- cbind(AllEvMat, Events)
  }
  AllRes[[i]] <- Res 
}
DataEvents <- t(AllEvMat[, -1])
rownames(DataEvents) <- YearsWithEvent 

PlottingDeclusterdEvents(Year = 1989,
                         Stations = c(1, 2, 11, 13, 15),
                         AllRes = AllRes,
                         ComTSs = ComTSs,
                         StsInfo = StsInfo,
                         filename = paste(root.dir, "/Plots/Declustering.pdf", sep=""))
```

## Figure 3ï¼šRiver distance vs Euclidean distance

```{r}
# Remove diagonal entries (same as before)
EucDis_no_diag <- EucDis[lower.tri(EucDis)]
RiverDis_no_diag <- RiverDis[lower.tri(RiverDis)]

# Create a data frame for plotting
df <- data.frame(Euclidean = EucDis_no_diag, River = RiverDis_no_diag)

# Create the ggplot
ggplot(df, aes(x = Euclidean, y = River)) +
  geom_point(color = "#2E86AB", alpha = 0.6, size = 1.5) +
  geom_abline(intercept = 0, slope = 1, 
              color = "#E63946", linetype = "dashed", linewidth = 1) +
  labs(
    title = "Comparison of Euclidean and River Distances",
    subtitle = "Each point represents a pair of locations",
    x = "Euclidean Distance (km)",
    y = "River Distance (km)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 11, hjust = 0.5, color = "gray50"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "gray80", fill = NA, linewidth = 0.5)
  ) +
  # coord_fixed(ratio = 1) +  # Equal aspect ratio
  annotate("text", x = 0.05, y = 0.95, 
           label = "y = x", color = "#E63946", size = 3.5, fontface = "italic")
ggsave(paste(root.dir, "/Plots/river_vs_euc.png", sep=""))
```


